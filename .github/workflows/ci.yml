# .github/workflows/ci.yml

name: CI - Retrain MLflow Model

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  mlflow_retrain:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    steps:
      
      # 1. Run actions/checkout@v3
      - name: Run actions/checkout@v3
        uses: actions/checkout@v4
        with:
          repository: ketutadinata/Eksperimen_SML_I_Ketut_Adinata_Vyarsa
          path: Eksperimen_SML_I_Ketut_Adinata_Vyarsa
          ref: main 
          token: ${{ secrets.REPO_ACCESS_TOKEN }} 

      # 2. Set up Python 3.12.7 (Menggunakan Miniconda)
      - name: Set up Python 3.12.7
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-activate-base: true
          
      # 3. Install dependencies (ðŸš¨ KOREKSI: Tambahkan instalasi dagshub)
      - name: Install dependencies
        run: |
          # Instal MLflow dan DagsHub di environment dasar agar binari keduanya dapat ditemukan
          conda install -c conda-forge mlflow dagshub -y 

      # 4. Check Env
      - name: Check Env
        run: |
          conda info
          
      # 5. Set MLflow Tracking URI (Konfigurasi Secrets)
      - name: Set MLflow Tracking URI
        run: |
          echo "DAGSHUB_USER=${{ secrets.DAGSHUB_USER }}" >> $GITHUB_ENV
          echo "DAGSHUB_TOKEN=${{ secrets.DAGSHUB_TOKEN }}" >> $GITHUB_ENV
          echo "KAGGLE_USERNAME=${{ secrets.KAGGLE_USERNAME }}" >> $GITHUB_ENV
          echo "KAGGLE_KEY=${{ secrets.KAGGLE_KEY }}" >> $GITHUB_ENV

      # 6. Run mlflow project (Termasuk Otentikasi DagsHub & menjalankan MLflow)
      - name: Run mlflow project
        working-directory: Eksperimen_SML_I_Ketut_Adinata_Vyarsa
        run: |
          # Perintah ini sekarang dapat menemukan 'dagshub' (dari Step 3)
          conda run -n base dagshub login --username $DAGSHUB_USER --token $DAGSHUB_TOKEN
          
          # Gunakan conda run untuk menemukan dan menjalankan MLflow
          conda run -n base mlflow run . --experiment-name CI_Retrain

      # 7. Install Python dependencies
      - name: Install Python dependencies
        run: |
          echo "Dependencies managed by MLflow project configuration."

      # 8. Upload to Google Drive (Menggunakan GitHub Artifacts)
      - name: Upload to Google Drive
        run: |
          # 1. Copy Artefak ke folder lokal
          mkdir -p final_artifacts
          cp Eksperimen_SML_I_Ketut_Adinata_Vyarsa/artifacts/best_model.pkl final_artifacts/
          cp Eksperimen_SML_I_Ketut_Adinata_Vyarsa/artifacts/scaler.pkl final_artifacts/

          # 2. Upload ke GitHub Artifacts (Menggantikan GDrive)
          actions/upload-artifact@v4 upload --name model-best-artifact --path final_artifacts/ --retention-days 7