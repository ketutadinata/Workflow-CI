name: CI - Retrain MLflow Model

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  mlflow_retrain:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      # 1. Checkout repo workflow (repo ini)
      - name: Checkout Workflow repo
        uses: actions/checkout@v4

      # 2. Checkout repo eksperimen (dataset)
      - name: Checkout Eksperimen repo
        uses: actions/checkout@v4
        with:
          repository: ketutadinata/Eksperimen_SML_I_Ketut_Adinata_Vyarsa
          path: eksperimen_repo
          token: ${{ secrets.REPO_ACCESS_TOKEN }}

      # 3. Setup Python
      - name: Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # 4. Install dependencies (NO CONDA, NO CONFLICT)
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas==2.1.1 numpy==1.26.0 scikit-learn==1.3.2 joblib==1.3.2
          pip install mlflow==2.9.2 matplotlib==3.8.1 seaborn==0.13.0

      # 5. Prepare artifacts folder & copy dataset
      - name: Prepare dataset
        run: |
          mkdir -p MLProject/artifacts
          cp eksperimen_repo/artifacts/train_preprocessed.csv MLProject/artifacts/
          echo "Artifacts content:"
          ls -lh MLProject/artifacts

      # 6. Run MLflow Project (INI INTI TUGAS)
      - name: Run MLflow Project
        working-directory: MLProject
        run: |
          export MLFLOW_TRACKING_URI=file:///tmp/mlruns
          mlflow run . \
            --experiment-name CI_Retrain \
            --env-manager=local

      # 7. Verify output artifacts
      - name: Verify model artifacts
        run: |
          ls -lh MLProject/artifacts
          test -f MLProject/artifacts/best_model.pkl
          test -f MLProject/artifacts/scaler.pkl
          echo "âœ… Artifacts verified"

      # 8. Upload artifacts to GitHub Actions
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: model-artifacts-${{ github.run_number }}
          path: |
            MLProject/artifacts/best_model.pkl
            MLProject/artifacts/scaler.pkl
          retention-days: 30

      # 9. Commit artifacts back to repo (opsional tapi kamu pakai)
      - name: Commit artifacts
        run: |
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"
          git add MLProject/artifacts/*.pkl || true
          git diff --staged --quiet || git commit -m "ðŸ¤– Model artifacts run #${{ github.run_number }}"
          git push || true
